import * as fs from "fs";
import * as path from "path";
import type { NextPage, GetStaticProps, GetStaticPaths } from "next";
import Head from "next/head";
import { Table } from "@components/Table";
import { BackButton } from "@components/buttons/BackButton";
import type { HeaderedTable } from "@libs/tableUtils";
import { dropColumnsByNames } from "@libs/tableUtils";
import { getTable, TableInfo } from "@services/tables";

type PageProps = { table: HeaderedTable<string>; tableInfo: TableInfo };

type PathParams = {
  id: string;
};

export const getStaticPaths: GetStaticPaths<PathParams> = (context) => {
  const paths = fs
    .readdirSync(path.resolve(process.cwd(), "data_in_repo", "tables"))
    .map((filename) => ({ params: { id: path.basename(filename, path.extname(filename)) } }));
  return {
    paths,
    fallback: false,
  };
};

export const getStaticProps: GetStaticProps<PageProps> = async (context) => {
  const { id } = context.params as PathParams;
  const { table, tableInfo } = getTable(id);

  return {
    props: { table, tableInfo },
  };
};

const TableOfId: NextPage<PageProps> = ({ table, tableInfo: info }: PageProps) => {
  const title = `è¡¨${info.index}. ${info.text}`;
  const [header, ...body] = dropColumnsByNames(table, ["id", "index", "H28ID"]);
  return (
    <>
      <Head>
        <title>{title}</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <header className="flex items-center p-2">
        <BackButton />
        <h1 className="m-4 text-xl font-bold">{title}</h1>
      </header>
      <div className="mx-4">
        <Table table={table} tableInfo={info} />
      </div>
    </>
  );
};

export default TableOfId;
